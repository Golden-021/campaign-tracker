<!DOCTYPE html>
<html>
<head>
  <title>Campaign Reporting</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <style>
    body { font-family: Arial; background: #f2f2f2; padding: 20px; }
    .box { background: white; padding: 20px; max-width: 900px; margin: auto; border-radius: 8px; }
    input, select, textarea, button { width: 100%; margin-top: 10px; padding: 8px; font-size: 15px; }
    h2 { text-align: center; }
    .section { margin-bottom: 30px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    #spinner {
      display: none;
      margin: 20px auto;
      border: 6px solid #eee;
      border-top: 6px solid #555;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    #calendar { max-width: 900px; margin: 40px auto; }
  </style>
</head>
<body>
  <div class="box">
    <h2>Campaign Reports</h2>
    <div>
      <label>Select Database:</label>
      <select id="dbDropdown">
        <option value="">-- Select Database --</option>
      </select>
      <button onclick="fetchByDatabase()">Show</button>
    </div>
    <div>
      <label>Date Range:</label>
      <input type="date" id="fromDate">
      <input type="date" id="toDate">
      <button onclick="fetchByDate()">Show</button>
    </div>
    <div id="spinner"></div>
    <div id="report"></div>
    <h2>Campaign Calendar</h2>
    <div id="calendar"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script>
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbzHlUoTop8QFLSfEG6aNqdpFAYxTdYs56BHcxGylZRAaJRQFK9fEmH8Qxg8HiTpALh66g/exec'; // Replace with your Apps Script Web App URL

    function showSpinner() {
      document.getElementById('spinner').style.display = 'block';
    }
    function hideSpinner() {
      document.getElementById('spinner').style.display = 'none';
    }

    function populateDropdown() {
      showSpinner();
      fetch(scriptUrl + '?action=getDatabaseNames')
        .then(res => res.json())
        .then(names => {
          const select = document.getElementById('dbDropdown');
          while (select.options.length > 1) select.remove(1);
          if (Array.isArray(names) && Array.isArray(names[0])) {
            names = names.map(row => row[0]);
          }
          names.forEach(name => {
            if (name && name.toString().trim()) {
              const opt = document.createElement('option');
              opt.value = name;
              opt.textContent = name;
              select.appendChild(opt);
            }
          });
          hideSpinner();
        })
        .catch(() => hideSpinner());
    }

    window.onload = function() {
      populateDropdown();
      loadCalendar();
    };

    function fetchByDatabase() {
      const db = document.getElementById('dbDropdown').value;
      if (!db) return;
      showSpinner();
      fetch(`${scriptUrl}?action=getCampaignsByDatabase&databaseName=${encodeURIComponent(db)}`)
        .then(res => res.json())
        .then(showReport)
        .finally(hideSpinner);
    }

    function fetchByDate() {
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;
      if (!from || !to) return;
      showSpinner();
      fetch(`${scriptUrl}?action=getCampaignsByDateRange&from=${from}&to=${to}`)
        .then(res => res.json())
        .then(showReport)
        .finally(hideSpinner);
    }

    function showReport(data) {
      if (!data.length) {
        document.getElementById('report').innerHTML = "<p>No data found.</p>";
        return;
      }
      let html = `<table>
        <tr>
          <th>Database</th>
          <th>Campaign Type</th>
          <th>Date</th>
          <th>No. of Records</th>
          <th>No. of Leads</th>
        </tr>`;
      data.forEach(row => {
        html += `<tr>
          <td>${row.databaseName || row.database_name || ''}</td>
          <td>${row.campaignType || row.campaign_type}</td>
          <td>${row.date}</td>
          <td>${row.noOfRecords || row.no_of_records}</td>
          <td>${row.noOfLeads || row.no_of_leads}</td>
        </tr>`;
      });
      html += "</table>";
      document.getElementById('report').innerHTML = html;
    }

    function loadCalendar() {
      showSpinner();
      fetch(scriptUrl + '?action=getAllCampaigns')
        .then(res => res.json())
        .then(data => {
          const events = data.map(row => ({
            title: `${row.databaseName || row.database_name} - ${row.campaignType || row.campaign_type} (${row.noOfLeads || row.no_of_leads} leads)`,
            start: row.date,
            allDay: true
          }));
          const calendarEl = document.getElementById('calendar');
          const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            events: events,
            headerToolbar: {
              left: 'prev,next today',
              center: 'title',
              right: 'dayGridMonth,listMonth'
            }
          });
          calendar.render();
          hideSpinner();
        })
        .catch(() => hideSpinner());
    }
  </script>
</body>
</html>
